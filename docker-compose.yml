name: stable-diffusion-webui-service

services:
  # MongoDB 数据库
  mongodb:
    image: mongo:7.0
    container_name: sd-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: yourStrongPassword123
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - sd-network
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/test --quiet
      interval: 10s
      timeout: 5s
      retries: 5

  # Stable Diffusion WebUI
  sd-webui:
    image: universonic/stable-diffusion-webui:full
    container_name: sd-webui-turbo
    restart: unless-stopped
    ports:
      - "50010:8080"
    environment:
      # MongoDB 配置
      - MONGODB_URI=mongodb://admin:yourStrongPassword123@mongodb:27017/
      - MONGODB_DATABASE=stable_diffusion
      - MONGODB_COLLECTION=turbo_gen_tasks
      
      # HuggingFace 镜像（中国用户）
      - HF_ENDPOINT=https://hf-mirror.com
      - TRANSFORMERS_CACHE=/app/.cache/huggingface/transformers
      - HF_HOME=/app/.cache/huggingface
      
      # 清华PyPI镜像
      - INDEX_URL=https://pypi.tuna.tsinghua.edu.cn/simple
    
    command: --medvram --xformers --opt-sdp-attention --api --listen
    
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    
    volumes:
      # 原有的所有目录挂载（持久化）
      - ./inputs:/app/stable-diffusion-webui/inputs
      - ./textual_inversion_templates:/app/stable-diffusion-webui/textual_inversion_templates
      - ./embeddings:/app/stable-diffusion-webui/embeddings
      - ./extensions:/app/stable-diffusion-webui/extensions
      - ./models:/app/stable-diffusion-webui/models
      - ./localizations:/app/stable-diffusion-webui/localizations
      - ./outputs:/app/stable-diffusion-webui/outputs
      - ./configs:/app/stable-diffusion-webui/configs
      - ./styles.csv:/app/stable-diffusion-webui/styles.csv
      # HuggingFace 缓存（持久化，避免重复下载）
      - ./huggingface-cache:/app/.cache/huggingface
      
      # Python虚拟环境（使用named volume避免权限问题）
      - sd-webui-venv:/app/stable-diffusion-webui/venv
      
      # 挂载modules代码（开发用）
      - ./modules:/app/stable-diffusion-webui/modules
    
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
 
    networks:
      - sd-network
    
    depends_on:
      mongodb:
        condition: service_healthy
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/"]
      interval: 30s
      timeout: 10s
      retries: 3

  # MongoDB Web 管理界面（可选）
  mongo-express:
    image: mongo-express:latest
    container_name: sd-mongo-express
    restart: unless-stopped
    ports:
      - "50011:8081"
    environment:
      ME_CONFIG_MONGODB_ADMINUSERNAME: admin
      ME_CONFIG_MONGODB_ADMINPASSWORD: yourStrongPassword123
      ME_CONFIG_MONGODB_URL: mongodb://admin:yourStrongPassword123@mongodb:27017/
      ME_CONFIG_BASICAUTH_USERNAME: admin
      ME_CONFIG_BASICAUTH_PASSWORD: admin
    networks:
      - sd-network
    depends_on:
      - mongodb

volumes:
  mongodb_data:
    driver: local
  mongodb_config:
    driver: local
  sd-webui-venv:
    driver: local

networks:
  sd-network:
    driver: bridge
